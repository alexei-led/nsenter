name: CI

on:
  push:
    branches: ["*"]
  pull_request:
    branches: [master]

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Lint Dockerfile with Hadolint
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        # DL3008: pin versions in apt-get â€” we want latest build tools
        ignore: DL3008

    - name: Lint shell scripts with ShellCheck
      uses: ludeeus/action-shellcheck@2.0.0
      with:
        scandir: .
        severity: warning

  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: lint

    steps:
    - uses: actions/checkout@v4

    - name: Get util-linux version
      id: get_util_linux
      run: |
        version=$(curl --silent --fail https://api.github.com/repos/util-linux/util-linux/tags \
          | jq -r '.[0].name' | sed -e 's/^v//')
        echo "version=${version}" >> "$GITHUB_OUTPUT"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image (amd64 only for CI speed)
      uses: docker/build-push-action@v6
      with:
        context: .
        build-args: UTIL_LINUX_VER=${{ steps.get_util_linux.outputs.version }}
        load: true
        tags: alexeiled/nsenter:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Run integration tests
      env:
        TEST_IMAGE: alexeiled/nsenter:test
      run: ./tests/test-docker.sh
