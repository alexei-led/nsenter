name: Auto-update on util-linux Release

on:
  schedule:
    - cron: "0 0 * * 1"  # Weekly on Monday
  workflow_dispatch:       # Allow manual trigger

permissions:
  contents: write

jobs:
  check_release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get latest repository tag
      id: get_latest_tag
      run: |
        tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
        echo "Current tag: ${tag}"
        echo "tag=${tag}" >> "$GITHUB_OUTPUT"

    - name: Get latest stable util-linux version
      id: get_util_linux
      run: |
        version=$(curl --silent --fail "https://api.github.com/repos/util-linux/util-linux/tags?per_page=20" | jq -r '[.[] | .name | select(test("^v[0-9]+\\.[0-9]+(\\.[0-9]+)?$"))][0]' | sed 's/^v//')
        if [ -z "$version" ] || [ "$version" = "null" ]; then
          echo "Error: could not fetch util-linux version" >&2
          exit 1
        fi
        echo "util-linux version: ${version}"
        echo "version=${version}" >> "$GITHUB_OUTPUT"

    - name: Create tag if new version available
      if: steps.get_latest_tag.outputs.tag != steps.get_util_linux.outputs.version
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        version="${{ steps.get_util_linux.outputs.version }}"
        echo "New version detected: ${version}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "${version}" -m "util-linux ${version}"
        git push origin "${version}"
